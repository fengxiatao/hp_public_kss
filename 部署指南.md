# FaceLocker 智能储物柜系统 - 现场部署指南

**版本**: 1.0  
**日期**: 2026-01-09  
**适用平台**: Rockchip RK3568/RK3588 ARM64 Linux

---

## 目录

1. [系统要求](#1-系统要求)
2. [部署包内容](#2-部署包内容)
3. [快速安装](#3-快速安装)
4. [手动安装步骤](#4-手动安装步骤)
5. [配置说明](#5-配置说明)
6. [百度SDK许可证激活](#6-百度sdk许可证激活)
7. [摄像头配置](#7-摄像头配置)
8. [启动与测试](#8-启动与测试)
9. [故障排除](#9-故障排除)
10. [卸载](#10-卸载)

---

## 1. 系统要求

### 硬件要求

| 项目 | 要求 |
|------|------|
| **处理器** | Rockchip RK3568 / RK3588 或兼容 SoC |
| **架构** | ARM64 (aarch64) |
| **内存** | ≥ 2GB RAM |
| **存储** | ≥ 1GB 可用空间 |
| **摄像头** | USB 摄像头（支持 MJPEG 格式） |
| **显示器** | 支持 HDMI/LVDS 输出 |

### 软件要求

| 项目 | 要求 | 检查命令 |
|------|------|----------|
| **操作系统** | Linux ARM64 (Ubuntu/Debian) | `uname -m` |
| **.NET Runtime** | 8.0 或更高版本 | `dotnet --version` |
| **Rockchip MPP** | 系统预装 | `ls /lib/aarch64-linux-gnu/librockchip_mpp.so` |
| **Rockchip RGA** | 系统预装 | `ls /lib/aarch64-linux-gnu/librga.so` |
| **V4L2** | 内核支持 | `ls /dev/video*` |

---

## 2. 部署包内容

```
facelocker_deploy/
├── app/                    # 主程序及依赖
│   ├── FaceLocker          # 可执行文件
│   ├── appsettings.json    # 配置文件
│   ├── *.dll               # .NET 依赖库
│   └── runtimes/           # 原生库
│       └── linux-arm64/
│           └── native/     # OpenCV 等库
├── native_libs/            # 硬件加速库
│   └── libv4l2_mpp_camera.so
├── baidu_sdk/              # 百度人脸识别SDK
│   ├── lib/armv8/          # SDK 库文件
│   ├── models/             # 人脸识别模型
│   ├── license/            # 许可证文件
│   └── conf/               # 配置文件
├── scripts/                # 安装脚本
│   └── install.sh
└── docs/                   # 文档
    └── 部署指南.md
```

---

## 3. 快速安装

### 一键安装（推荐）

```bash
# 1. 解压部署包
tar -xzvf facelocker_deploy.tar.gz
cd facelocker_deploy

# 2. 运行安装脚本
sudo ./scripts/install.sh

# 3. 启动程序
facelocker
```

---

## 4. 手动安装步骤

如果自动安装失败，请按以下步骤手动安装：

### 4.1 安装 .NET 8.0 Runtime

```bash
# 下载安装脚本
wget https://dot.net/v1/dotnet-install.sh
chmod +x dotnet-install.sh

# 安装 .NET 8.0 Runtime
./dotnet-install.sh --channel 8.0 --runtime dotnet

# 添加到环境变量
echo 'export DOTNET_ROOT=$HOME/.dotnet' >> ~/.bashrc
echo 'export PATH=$PATH:$DOTNET_ROOT' >> ~/.bashrc
source ~/.bashrc

# 验证安装
dotnet --version
```

### 4.2 安装原生库

```bash
# 复制硬件加速库
sudo cp native_libs/libv4l2_mpp_camera.so /usr/local/lib/

# 更新库缓存
sudo ldconfig

# 验证安装
ldconfig -p | grep v4l2_mpp
```

### 4.3 安装百度SDK

```bash
# 复制SDK到系统目录
sudo cp -r baidu_sdk /opt/face_offline_sdk

# 配置库路径
echo "/opt/face_offline_sdk/lib/armv8" | sudo tee /etc/ld.so.conf.d/baidu_face_sdk.conf
sudo ldconfig

# 验证安装
ldconfig -p | grep baidu
```

### 4.4 安装应用程序

```bash
# 创建安装目录
sudo mkdir -p /opt/facelocker

# 复制程序文件
sudo cp -r app/* /opt/facelocker/

# 设置执行权限
sudo chmod +x /opt/facelocker/FaceLocker
```

### 4.5 创建启动脚本

```bash
# 创建启动脚本
sudo tee /usr/local/bin/facelocker << 'EOF'
#!/bin/bash
cd /opt/facelocker
export LD_LIBRARY_PATH=/opt/facelocker/runtimes/linux-arm64/native:/opt/face_offline_sdk/lib/armv8:$LD_LIBRARY_PATH
export DISPLAY=${DISPLAY:-:0}
./FaceLocker "$@"
EOF

sudo chmod +x /usr/local/bin/facelocker
```

---

## 5. 配置说明

配置文件位置: `/opt/facelocker/appsettings.json`

### 5.1 摄像头配置

```json
"Camera": {
  "DefaultCameraIndex": 12,
  "DevicePath": "/dev/video12",
  "FrameRate": 30,
  "Resolution": {
    "Width": 640,
    "Height": 480
  }
}
```

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `DevicePath` | 摄像头设备路径 | /dev/video12 |
| `FrameRate` | 帧率 | 30 |
| `Resolution.Width` | 分辨率宽度 | 640 |
| `Resolution.Height` | 分辨率高度 | 480 |

### 5.2 百度人脸识别配置

```json
"BaiduFace": {
  "IdentifyScore": 80,
  "ModelPath": "/opt/face_offline_sdk",
  "LicenseKey": "/opt/face_offline_sdk/license/license.ini",
  "MaxDetectNum": 5,
  "MinFaceSize": 0,
  "SimilarityThreshold": 0.8
}
```

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `IdentifyScore` | 人脸识别阈值 | 80 |
| `ModelPath` | SDK路径 | /opt/face_offline_sdk |
| `LicenseKey` | 许可证路径 | license/license.ini |

---

## 6. 百度SDK许可证激活

**⚠️ 重要**: 百度人脸SDK的许可证通常绑定到特定硬件，部署到新设备需要重新激活。

### 6.1 获取设备指纹

```bash
# 运行SDK示例程序获取设备指纹
cd /opt/face_offline_sdk
./run.sh  # 或查看相关文档
```

### 6.2 激活许可证

1. 联系百度SDK供应商获取新的 `license.ini`
2. 将新的许可证文件复制到 `/opt/face_offline_sdk/license/`
3. 重启程序

### 6.3 验证许可证

```bash
# 查看日志确认SDK初始化成功
facelocker 2>&1 | grep -i "sdk\|license\|初始化"
```

---

## 7. 摄像头配置

### 7.1 查找摄像头设备

```bash
# 列出所有视频设备
ls -la /dev/video*

# 查看设备详情
v4l2-ctl --list-devices

# 检查特定设备能力
v4l2-ctl -d /dev/video12 --all
```

### 7.2 测试摄像头

```bash
# 测试摄像头是否正常
v4l2-ctl -d /dev/video12 --stream-mmap --stream-count=10

# 查看支持的格式
v4l2-ctl -d /dev/video12 --list-formats-ext
```

### 7.3 修改摄像头设备

如果摄像头不在 `/dev/video12`，编辑配置文件：

```bash
sudo nano /opt/facelocker/appsettings.json
# 修改 "DevicePath": "/dev/videoX" 为正确的设备路径
```

---

## 8. 启动与测试

### 8.1 启动程序

```bash
# 方式1: 使用启动脚本
facelocker

# 方式2: 手动启动
cd /opt/facelocker
export LD_LIBRARY_PATH=$(pwd)/runtimes/linux-arm64/native:/opt/face_offline_sdk/lib/armv8:$LD_LIBRARY_PATH
DISPLAY=:0 ./FaceLocker
```

### 8.2 后台运行

```bash
# 使用 nohup 后台运行
nohup facelocker > /var/log/facelocker.log 2>&1 &

# 或使用 systemd 服务（需要创建服务文件）
```

### 8.3 开机自启动

创建 systemd 服务文件：

```bash
sudo tee /etc/systemd/system/facelocker.service << 'EOF'
[Unit]
Description=FaceLocker Smart Locker System
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/facelocker
Environment=DISPLAY=:0
Environment=LD_LIBRARY_PATH=/opt/facelocker/runtimes/linux-arm64/native:/opt/face_offline_sdk/lib/armv8
ExecStart=/opt/facelocker/FaceLocker
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# 启用服务
sudo systemctl daemon-reload
sudo systemctl enable facelocker
sudo systemctl start facelocker
```

---

## 9. 故障排除

### 9.1 常见问题

#### 问题1: "librockchip_mpp.so not found"

```bash
# 解决: 确认 MPP 库已安装
ls /lib/aarch64-linux-gnu/librockchip_mpp.so*

# 如果不存在，需要从 Rockchip 官方镜像安装
```

#### 问题2: "摄像头无法打开"

```bash
# 检查设备是否存在
ls /dev/video*

# 检查权限
sudo chmod 666 /dev/video12

# 检查是否被占用
fuser /dev/video12
```

#### 问题3: "百度SDK初始化失败"

```bash
# 检查许可证
cat /opt/face_offline_sdk/license/license.ini

# 检查模型文件
ls /opt/face_offline_sdk/models/

# 检查日志
tail -f /opt/face_offline_sdk/face_sdk.log
```

#### 问题4: ".NET Runtime 未找到"

```bash
# 重新安装 .NET
wget https://dot.net/v1/dotnet-install.sh
chmod +x dotnet-install.sh
./dotnet-install.sh --channel 8.0 --runtime dotnet
```

### 9.2 日志查看

```bash
# 实时查看程序日志
facelocker 2>&1 | tee /tmp/facelocker.log

# 查看百度SDK日志
tail -f /opt/face_offline_sdk/face_sdk.log
```

### 9.3 性能检查

```bash
# 运行程序并查看性能统计
facelocker 2>&1 | grep "性能统计"

# 正常输出示例:
# [性能统计] 显示FPS: 30.0, 平均帧处理: 0.5ms
```

---

## 10. 卸载

```bash
# 停止服务
sudo systemctl stop facelocker 2>/dev/null
sudo systemctl disable facelocker 2>/dev/null

# 删除程序文件
sudo rm -rf /opt/facelocker
sudo rm -f /usr/local/bin/facelocker
sudo rm -f /etc/systemd/system/facelocker.service

# 删除百度SDK（可选）
sudo rm -rf /opt/face_offline_sdk
sudo rm -f /etc/ld.so.conf.d/baidu_face_sdk.conf

# 删除原生库
sudo rm -f /usr/local/lib/libv4l2_mpp_camera.so

# 更新库缓存
sudo ldconfig
```

---

## 附录: 技术支持

如有问题，请联系技术支持并提供以下信息：

1. 系统信息: `uname -a`
2. .NET 版本: `dotnet --version`
3. 程序日志: `/tmp/facelocker.log`
4. SDK 日志: `/opt/face_offline_sdk/face_sdk.log`
5. 摄像头信息: `v4l2-ctl --list-devices`

---

**文档结束**
